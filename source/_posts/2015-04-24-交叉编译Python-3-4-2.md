---
title: 交叉编译Python-3.4.2
date: 2015-04-24 19:47:29
tags:
- 嵌入式
categories:
- Linux
---

交叉编译Python-3.4.2到ARM方法及步骤，备忘。

#0 准备

编译环境目录结构如下
```
~/work
├── build
│   ├── lib        // 编译生成的依赖库文件
│   └── python     // 编译生成的python文件
└── src
    ├── bzip2-1.0.6
    ├── gdbm-1.11
    ├── ncurses-5.9
    ├── openssl-1.0.2a
    ├── Python-3.4.2
    ├── readline-6.3
    ├── sqlite-autoconf-3080500
    └── xz-5.0.5

```

```
export WORKDIR=~/work
export HOST=arm-linux-gnueabi
export PREFIX=$WORKDIR/build/lib
export PREFIX_PYTHON=$WORKDIR/build/python

export CFLAGS="-I$PREFIX/include"
export LDFLAGS="-L$PREFIX/lib"
```

#1 编译ncurses-5.9

```
./configure --prefix=$PREFIX --host=$HOST
make && make install
```

#2 编译readline库
```
bash_cv_wcwidth_broken=no ./configure --prefix=$PREFIX --host=$HOST --enable-shared=no --with-curses=ncurses
make && make install
```
#3 编译bzip2库
修改Makefile，patch如下
```
--- Makefile.old    2015-04-24 15:36:49.420543465 +0800
+++ Makefile    2015-04-24 15:41:00.436534604 +0800
@@ -15,16 +15,17 @@
 SHELL=/bin/sh
 
 # To assist in cross-compiling
-CC=gcc
-AR=ar
-RANLIB=ranlib
+CROSS_COMPILE=arm-linux-gnueabi-
+CC=$(CROSS_COMPILE)gcc
+AR=$(CROSS_COMPILE)ar
+RANLIB=$(CROSS_COMPILE)ranlib
 LDFLAGS=
 
 BIGFILES=-D_FILE_OFFSET_BITS=64
 CFLAGS=-Wall -Winline -O2 -g $(BIGFILES)
 
 # Where you want it installed when you do 'make install'
-PREFIX=/usr/local
+#PREFIX=/usr/local
 
 
 OBJS= blocksort.o  \
@@ -35,7 +36,7 @@
       decompress.o \
       bzlib.o
 
-all: libbz2.a bzip2 bzip2recover test
+all: libbz2.a
 
 bzip2: libbz2.a bzip2.o
    $(CC) $(CFLAGS) $(LDFLAGS) -o bzip2 bzip2.o -L. -lbz2
@@ -69,44 +70,13 @@
    cmp sample3.tst sample3.ref
    @cat words3
 
-install: bzip2 bzip2recover
-   if ( test ! -d $(PREFIX)/bin ) ; then mkdir -p $(PREFIX)/bin ; fi
+install: libbz2.a
    if ( test ! -d $(PREFIX)/lib ) ; then mkdir -p $(PREFIX)/lib ; fi
-   if ( test ! -d $(PREFIX)/man ) ; then mkdir -p $(PREFIX)/man ; fi
-   if ( test ! -d $(PREFIX)/man/man1 ) ; then mkdir -p $(PREFIX)/man/man1 ; fi
    if ( test ! -d $(PREFIX)/include ) ; then mkdir -p $(PREFIX)/include ; fi
-   cp -f bzip2 $(PREFIX)/bin/bzip2
-   cp -f bzip2 $(PREFIX)/bin/bunzip2
-   cp -f bzip2 $(PREFIX)/bin/bzcat
-   cp -f bzip2recover $(PREFIX)/bin/bzip2recover
-   chmod a+x $(PREFIX)/bin/bzip2
-   chmod a+x $(PREFIX)/bin/bunzip2
-   chmod a+x $(PREFIX)/bin/bzcat
-   chmod a+x $(PREFIX)/bin/bzip2recover
-   cp -f bzip2.1 $(PREFIX)/man/man1
-   chmod a+r $(PREFIX)/man/man1/bzip2.1
    cp -f bzlib.h $(PREFIX)/include
    chmod a+r $(PREFIX)/include/bzlib.h
    cp -f libbz2.a $(PREFIX)/lib
    chmod a+r $(PREFIX)/lib/libbz2.a
-   cp -f bzgrep $(PREFIX)/bin/bzgrep
-   ln -s -f $(PREFIX)/bin/bzgrep $(PREFIX)/bin/bzegrep
-   ln -s -f $(PREFIX)/bin/bzgrep $(PREFIX)/bin/bzfgrep
-   chmod a+x $(PREFIX)/bin/bzgrep
-   cp -f bzmore $(PREFIX)/bin/bzmore
-   ln -s -f $(PREFIX)/bin/bzmore $(PREFIX)/bin/bzless
-   chmod a+x $(PREFIX)/bin/bzmore
-   cp -f bzdiff $(PREFIX)/bin/bzdiff
-   ln -s -f $(PREFIX)/bin/bzdiff $(PREFIX)/bin/bzcmp
-   chmod a+x $(PREFIX)/bin/bzdiff
-   cp -f bzgrep.1 bzmore.1 bzdiff.1 $(PREFIX)/man/man1
-   chmod a+r $(PREFIX)/man/man1/bzgrep.1
-   chmod a+r $(PREFIX)/man/man1/bzmore.1
-   chmod a+r $(PREFIX)/man/man1/bzdiff.1
-   echo ".so man1/bzgrep.1" > $(PREFIX)/man/man1/bzegrep.1
-   echo ".so man1/bzgrep.1" > $(PREFIX)/man/man1/bzfgrep.1
-   echo ".so man1/bzmore.1" > $(PREFIX)/man/man1/bzless.1
-   echo ".so man1/bzdiff.1" > $(PREFIX)/man/man1/bzcmp.1
 
 clean: 
    rm -f *.o libbz2.a bzip2 bzip2recover \
```

编译
```
make && make install
```

#4 编译gdbm库
```
./configure --prefix=$PREFIX --host=$HOST --enable-libgdbm-compat --enable-shared=no
make && make install
```

#5 编译openssl库
```
待添加...
```

#6 编译sqlite库
```
./configure --prefix=$PREFIX --host=$HOST --enable-shared=no
make && make install
```

#7 编译xz
```
./configure --prefix=$PREFIX --host=$HOST --enable-shared=no
make && make install
```

#8 编译Python
先编译host版的python和pgen
```
./configure
make BUILDPYTHON=hostpython hostpython PGEN=Parser/hostpgen Parser/hostpgen
make distclean
```

打补丁
```
diff -ru Python-3.4.2/Makefile.pre.in Python-3.4.2-android/Makefile.pre.in
--- Python-3.4.2/Makefile.pre.in    2014-03-09 09:40:23.000000000 +0100
+++ Python-3.4.2-android/Makefile.pre.in    2014-08-04 22:13:00.000000000 +0200
@@ -674,7 +674,7 @@
 $(GRAMMAR_H): $(GRAMMAR_INPUT) $(PGENSRCS)
        @$(MKDIR_P) Include
        $(MAKE) $(PGEN)
-       $(PGEN) $(GRAMMAR_INPUT) $(GRAMMAR_H) $(GRAMMAR_C)
+       $(HOSTPGEN) $(GRAMMAR_INPUT) $(GRAMMAR_H) $(GRAMMAR_C)
 $(GRAMMAR_C): $(GRAMMAR_H) $(GRAMMAR_INPUT) $(PGENSRCS)
        $(MAKE) $(GRAMMAR_H)
        touch $(GRAMMAR_C)
@@ -1243,6 +1243,7 @@
 # Install the dynamically loadable modules
 # This goes into $(exec_prefix)
 sharedinstall: sharedmods
+   CC='$(CC)' LDSHARED='$(BLDSHARED)' LDFLAGS='$(LDFLAGS)' OPT='$(OPT)' CROSS_COMPILE='$(CROSS_COMPILE)' \
    $(RUNSHARED) $(PYTHON_FOR_BUILD) $(srcdir)/setup.py install \
        --prefix=$(prefix) \
        --install-scripts=$(BINDIR) \
diff -ru Python-3.4.2/configure Python-3.4.2-android/configure
--- Python-3.4.2/configure  2014-03-09 09:40:34.000000000 +0100
+++ Python-3.4.2-android/configure  2014-08-04 22:13:00.000000000 +0200
@@ -2943,13 +2943,18 @@
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for python interpreter for cross build" >&5
 $as_echo_n "checking for python interpreter for cross build... " >&6; }
     if test -z "$PYTHON_FOR_BUILD"; then
-        for interp in python$PACKAGE_VERSION python3 python; do
-       which $interp >/dev/null 2>&1 || continue
-       if $interp -c 'import sys;sys.exit(not sys.version_info[:2] >= (3,3))'; then
-           break
-       fi
-            interp=
-   done
+        if test ! -z "$HOSTPYTHON" && PYTHONPATH="$ac_abs_confdir/Lib" "$HOSTPYTHON" -S -c 'import sys;sys.exit(not sys.version_info[:2] >= (3,3))'; then
+            interp="$HOSTPYTHON"
+        else
+            for interp in python$PACKAGE_VERSION python3 python; do
+           which $interp >/dev/null 2>&1 || continue
+           if $interp -c 'import sys;sys.exit(not sys.version_info[:2] >= (3,3))'; then
+               break
+           fi
+                interp=
+       done
+        fi
+
         if test x$interp = x; then
        as_fn_error $? "python$PACKAGE_VERSION interpreter not found" "$LINENO" 5
    fi
diff -ru Python-3.4.2/configure.ac Python-3.4.2-android/configure.ac
--- Python-3.4.2/configure.ac   2014-03-09 09:40:34.000000000 +0100
+++ Python-3.4.2-android/configure.ac   2014-08-04 22:13:00.000000000 +0200
@@ -56,13 +56,18 @@
 if test "$cross_compiling" = yes; then
     AC_MSG_CHECKING([for python interpreter for cross build])
     if test -z "$PYTHON_FOR_BUILD"; then
-        for interp in python$PACKAGE_VERSION python3 python; do
-       which $interp >/dev/null 2>&1 || continue
-       if $interp -c 'import sys;sys.exit(not sys.version_info@<:@:2@:>@ >= (3,3))'; then
-           break
-       fi
-            interp=
-   done
+        if test ! -z "$HOSTPYTHON" && PYTHONPATH="$ac_abs_confdir/Lib" "$HOSTPYTHON" -S -c 'import sys;sys.exit(not sys.version_info@<:@:2@:>@ >= (3,3))'; then
+            interp="$HOSTPYTHON"
+        else
+            for interp in python$PACKAGE_VERSION python3 python; do
+           which $interp >/dev/null 2>&1 || continue
+           if $interp -c 'import sys;sys.exit(not sys.version_info@<:@:2@:>@ >= (3,3))'; then
+               break
+           fi
+                interp=
+       done
+        fi
+
         if test x$interp = x; then
        AC_MSG_ERROR([python$PACKAGE_VERSION interpreter not found])
    fi

diff -ru Python-3.4.2/setup.py Python-3.4.2-android/setup.py
--- Python-3.4.2/setup.py   2014-03-09 09:40:34.000000000 +0800
+++ Python-3.4.2-android/setup.py   2014-08-04 22:13:00.000000000 +0800
@@ -1060,7 +1060,7 @@
                              '/usr/local/include/sqlite3',
                              ]
         if cross_compiling:
-            sqlite_inc_paths = []
+            sqlite_inc_paths = ['/home/lijg/work/build/lib/include']
         MIN_SQLITE_VERSION_NUMBER = (3, 0, 8)
         MIN_SQLITE_VERSION = ".".join([str(x)
                                     for x in MIN_SQLITE_VERSION_NUMBER])
```

编译arm版本的python

```
cat > config.site <<-SITE
    ac_cv_file__dev_ptmx=no
    ac_cv_file__dev_ptc=no
SITE

./configure CROSS_COMPILE_TARGET=yes HOSTPYTHON="$(pwd)/hostpython" CONFIG_SITE=config.site --prefix=$PREFIX_PYTHON --host=arm-linux-gnueabi --disable-ipv6 --without-ensurepip

make CROSS_COMPILE_TARGET=yes HOSTPYTHON="$(pwd)/hostpython" HOSTPGEN="$(pwd)/Parser/hostpgen"

make CROSS_COMPILE_TARGET=yes HOSTPYTHON="$(pwd)/hostpython" HOSTPGEN="$(pwd)/Parser/hostpgen" install
```

