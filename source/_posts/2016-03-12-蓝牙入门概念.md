---
title: 蓝牙入门概念
date: 2016-03-12 18:00:27
tags: 
- 蓝牙
categories: 
- 硬件
---

低功耗蓝牙(BLE)协议是一个多层协议，官方的介绍比较复杂，这里只挑两个必须掌握的介绍一下，GAP和GATT。

![Image](/images/2016-04-14/19-42-54.jpg)

# 1 GAP

GAP全称是通用访问规范(Generic Access Profile)，通过名字就可以猜到这个是管理底层连接的。

GAP中规定了以下几个术语：

## 1.1 角色

BLE可以看做是一个主从式结构，一个主机（集中器），一个设备。比如，蓝牙手环应用，手机是主机（集中器），蓝牙手环是设备。

现在的手机一般都支持两种模式，既可以当主机，又可以当设备。但在某个确定的场景中，只能是一种身份。

Nordic提供的协议栈中（底层库），S110是只支持设备模式，S120只支持主机模式，S130两者都支持。

## 1.2 广播

广播是`设备`发起的活动。

设备想要被主机搜扫到，必须发起广播。有一些参数用来设置广播的信息（如设备名等）、间隔等信息。 设备在广播时，所有可见范围内的主机都可以接收到广播信息，从而发现设备。

主机接收到广播后，相当于建立起的初步联系，此时两者可以沟通以获取更多的信息，这个过程叫扫描回应。

## 1.3 扫描

扫描是`主机`发起的活动。扫描其实就是主机让自己出去接收广播的状态，从而发现设备。

扫描一般不会一直持续下去，一般在手机上系统扫描一段时间就会自动停止。当选定某一个设备连接时也自动停止扫描。

## 1.4 连接

主机想要连接到一个设备时，发起一个连接请求。

之后两者根据协议建立连接，都是底层的一些协议规定，就不细讲了。

# 2 GATT

GATT全称是通用属性配置文件(Generic Attribute Profile)，是用来描述设备或主机的各种属性的。而属性就是各种可以读写的信息，主机和设备之间就靠读写这些属性来沟通。

比如，一个蓝牙设备可以用一个可读写的特性（特性与属性的区别见下文）来表征一个LED的开关。当手机和蓝牙设备建立连接后可以向这个特性写入0或者1。蓝牙设备就可以通过特性的值来打开或关闭LED。

![Image](/images/2016-04-14/19-43-35.jpg)

GATT中规定了以下几个术语：

## 2.1 角色

GATT中也分为两个角色，GATT服务器和GATT客户端。

提供属性的设备称为GATT服务器，访问GATT服务器而获得属性的设备称为GATT客户端。

比如之前的例子，手机通过访问蓝牙设备的属性来控制LED，所以蓝牙设备就是GATT服务器，手机就是GATT客户端。

## 2.2 属性

属性是GATT服务器中最基本的单元。GATT服务器将其所有的属性组成一个属性表。

一个属性包含句柄、UUID、值：

* 句柄是属性在GATT表中的索引。我们一般用不到
* UUID是属性的ID，包含了属性值的类型等信息
* 可能有多个属性拥有同一个UUID

## 2.3 特性

一个特性至少包含2个属性：一个属性用于声明(又叫描述符)，一个属性用于存放特性的值。

存放特性值的属性就是真正传输的数据，声明属性用来确定该特性是否可读写、是否可以发起通知（类似于向主机发起中断）等信息。

比如，LED状态就是一个特性，该特性可读写。

## 2.4 描述符

描述符就是用于声明的属性。 有一个特别的描述符值得特别地提起：客户端特性配置描述符(Client Characteristic Configuration Descriptor，CCCD)，这个描述符是给任何支持通知或指示功能的特性额外增加的。在CCCD中写入“1”使能通知功能，写入“2”使能指示功能，写入“0”同时禁止通知和指示功能。

在S110协议栈中，对任何使能了通知功能或是指示功能的特性，协议栈将自动加入这个类型的描述符。

## 2.5 服务

一个服务包含一个或多个特性，这些特性是逻辑上相关的集合体。

GATT服务一般包含几块具有相关的功能，比如特定传感器的读取和设置，人机接口的输入输出。组织具有相关的特性到服务中既实用又有效，因为它使得逻辑上和用户数据上的边界变得更加清晰，同时它也有助于不同应用程序间代码的重用。

## 2.6 数据配置文件

一个profile文件可以包含一个或者多个服务，一个profile文件包含需要的服务的信息或者为对等设备如何交互的配置文件的选项信息。

其实就是层层封装，目的是为应用提供方便，也更好的重用。

# 3 其他

## 3.1 标准服务、定制服务

标准服务就是蓝牙技术联盟（SIG）事先定义好的一些服务。
定制服务就是你自己开发的服务。

## 3.2 UUID

UUID有128bit, 如 
```
0x00001234-0000-1000-8000-00805F9B34FB
```

一般使用的时候，会先生成一个基本UUID，比如`0x0000xxxx-0000-1000-8000-00805F9B34FB`，然后根据需要定义16bit的`xxxx`，生成完成的UUID。

目的可能是为了更好的区分，比如一个公司使用相同的基本UUID，然后通过不同的`xxxx`来区分不同的服务、特性等。

## 3.3 操作类型(性质)

特性的操作类型有：
* 写
* 没有回应的写
* 读
* 通知
* 指示（有回应的通知）

通过字面意思就可以理解，比如LED特性，需要写和读性质。如果设备有事件需要上报，比如按键等，就需要通知或者指示性质。通知就是上报完就没事了，指示的话还需要主机给个响应。