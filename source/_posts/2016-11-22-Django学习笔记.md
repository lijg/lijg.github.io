---
title: Django学习笔记
date: 2016-11-22 22:22:32
tags:
- Python
- Django
categories:
- Linux
---

使用3天时间学习了Django并搭建了一个网站，感觉非常不错，记录一下学习过程。

## 0 快速入门

只需要简单几个命令，
```
virtuelenv test
source test/bin/activate
pip install django Pillow
django-admin startproject testprj
cd testprj
django-admin startapp website
python manager.py runserver 0.0.0.0:8000
```

## 1 模型设计(Model)

Django提供了一套ORM，用来将用Python类描述的数据结构映射到数据库中，使用起来非常简单。

示例如下：
```
#!/usr/bin/env python
# -*- coding: utf-8 -*-

# 引入models，orm所有用到的模型都在这个里面
from django.db import models

# 在Django中，模型用类来表示，必须继承自models.Model
class User(models.Model):
    # 自动包含一个id，Integer类型(IntegerField)，自动增长

    # 定义一条数据，代表数据库中的一列
    # 该列的类型是字符串(CharField)，最大长度为70
    name = models.CharField(max_length=70)

    # email列的类型是Email，保存到数据库时会检查该email的合法性
    # 也可以用CharField，但就不能自动检查email的合法性了
    email = models.EmailField(max_length=254)

    # DateTimeField类型可以保存时间
    # auto_now_add=True代表add记录时自动填入当前的时间
    created_at = models.DateTimeField(auto_now_add=True)

    # auto_now=Ture代表，每次更新（add或update）时，都会填入当前时间
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): # __unicode__ on Python 2
        # print该类型的对象时，打印的字符串
        # 在Python2中使用 __unicode__
        return self.name

class Article(models.Model):
    title = models.CharField(max_length=254)

    # TextField用来存储大段的文字
    content = models.TextField()

    # 定义一个外键，引用User表中的数据
    # 正向引用：a = Article(...), print a.user.name
    # 反向引用：u = User..., print u.article_set
    # on_delete的意思时，当指向的user被删除时，该Article应该怎么办
    #  CASCADE: 关联操作，User被删除时，对应的Article也被删除
    #  PROTECT：抛出ProtectedError异常，留给用户处理
    #  SET_NULL: User被删除时，将user设置为null
    #  SET_DEFAULT: 设置成默认值，此时user字段必须设置default=xxx
    #  SET(xxx): 设置成xxx
    user = models.ForeignKey(
        'User', on_delete=models.CASCADE,
        )

    created_at = models.DateTimeField(auto_now_add=True)
    
    updated_at = models.DateTimeField(auto_now=True)
```

第一次使用时，通过以下命令创建数据库及表格
```
python manage.py migrate
```


## 2 URL设计
`Django`使用一张urlpatterns表格来匹配访问的url。先看个例子。

```
from django.conf.urls import url
from . import views

urlpatterns = [
    url(r'^articles/([0-9]{4})/$', views.year_archive),
    url(r'^articles/([0-9]{4})/([0-9]{2})/$', views.month_archive),
    url(r'^articles/([0-9]{4})/([0-9]{2})/([0-9]+)/$', views.article_detail),
]
```
代码中，每一行url代表一类url。url的第一个参数时一个正则表达式，用来匹配url。第二个参数是访问该url时的回调函数。

第一行会匹配类似`/articles/2016/`这样的url，当用户访问时，会调用`views.year_archive(request, '2016')`。

第二行会匹配'/articles/2016/11/'这样的url，当用户访问时，会调用`views.month_archive(request, '2016', '11')`。

第三行类似。

## 3 View设计

View是用户访问url时实际执行的动作代码，看个例子。
```
from django.shortcuts import render
from .models import Article

def year_archive(request, year):
    a_list = Article.objects.filter(created_at__year=year)
    context = {'year': year, 'article_list': a_list}
    return render(request, 'news/year_archive.html', context)
```

当访问'/articles/2016/'时，会从数据库中检索到所有创建时间为2016年的所有文章，并将检索到的文章返回。

## 4 模板设计

还是用例子说明。

```
{% raw %}
{% extends "base.html" %}
{% block title %}Articles for {{ year }}{% endblock %}

{% block content %}
<h1>Articles for {{ year }}</h1>
{% for article in article_list %}
    <p>{{ article.title }}</p>
    <p>By {{ article.user.name }}</p>
    <p>Published {{ article.pub_date|date:"F j, Y" }}</p>
{% endfor %}
{% endblock %}
{% endraw %}
```

第一行表明该模板继承`base.html`。后续通过`block`重载其中的一些部分。
{% raw %}
第二行表明，用`Articles for {{ year }}`重载`base.html`中`{% block title %}{% endblock %}`之间的部分。

第9行，`{{ article.pub_date|date:"F j, Y" }}`，用来给前面的数据格式化，叫做`template filters`。
{% endraw %}
`base.html`的内容如下：
```
{% raw %}
{% load static %}
<html>
<head>
    <title>{% block title %}{% endblock %}</title>
</head>
<body>
    <img src="{% static "images/sitelogo.png" %}" alt="Logo" />
    {% block content %}{% endblock %}
</body>
</html>
{% endraw %}
```

## 5 一个完成的例子

### 5.1 创建工程和APP
```
django-admin startproject mysite
python manage.py startapp todo
```

### 5.2 编辑 todo/models.py
```
from django.db import models
from django.utils.encoding import python_2_unicode_compatible

@python_2_unicode_compatible
class ToDo(models.Model):
    title = models.CharField(max_length=200)
    done = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.title
```

### 5.3 编辑 mysite/settings.py
```
INSTALLED_APPS = [
    'todo.apps.TodoConfig',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
```

### 5.4 生成数据库表
```
python manager.py makemigrations todo
python manager.py sqlmigrate todo 0001
python manager.py migrate
```

### 5.5 编辑 todo/views.py
```
from django.shortcuts import render
from django.http import HttpResponseRedirect
from django.urls import reverse
from .models import ToDo

def index(request):
    if request.method == 'POST':
        todo = ToDo(title=request.POST['todo'])
        todo.save()
        return HttpResponseRedirect(reverse('todo:index'))
    else:
        todo_list = Todo.objects.order_by('created_at')
        return render(request, 'todo/index.html', {
            'todo_list': todo_list
        })
```

### 5.6 创建 todo/urls.py
```
from django.conf.urls import url
from . import views
urlpatterns = [
    url(r'^$', views.index, name='index'),
]
```

### 5.7 编辑 mysite/urls.py
```
from django.conf.urls import include, url
from django.contrib import admin

app_name = 'todo'
urlpatterns = [
    url(r'^todo/', include('todo.urls')),
    url(r'^admin/', admin.site.urls),
]
```

### 5.8 编辑todo/templates/todo/index.html
```
{% raw %}
<html>
<head>
    <title>ToDo List</title>
</head>
<body>
    <h1>ToDo List</h1>
    {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
    <ul>
    {% for todo in todo_list %}
        <li>{{ todo.title }}</li>
    {% endfor %}
    </ul>
    <hr />
    <form action="{% url 'todo:index' %}" method="post">
        {% csrf_token %}
        <input type="text" name="todo" />
        <input type="submit" value="Add" />
    </form>
</body>
</html>
{% endraw %}
```

### 5.9 创建超级用户
```
python manage.py createsuperuser
```

### 5.10 使用Admin管理数据库
编辑 todo/admin.py
```
from django.contrib import admin
from .models import ToDo

admin.site.register(ToDo)
```

