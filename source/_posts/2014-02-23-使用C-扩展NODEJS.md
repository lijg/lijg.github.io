---
title: 使用C++扩展NODEJS
date: 2014-02-23 22:56:54
tags:
- nodejs
categories:
- Linux
---

> 目的：使用c/c++控制硬件，nodejs做web后端，实现网络设备

使用`C/C++`来扩展`NodeJs`是非常容易的，像几乎所有的教程一下，我们先来个HelloWorld：

```
// helloworld.cpp

#include <node.h>    //首先引入node头文件

using namespace v8;  //使用V8和，node命名空间
using namespace node;

/**
 * 这个就是我们要扩展到NodeJs的c函数了，函数的原型一定得是
 * Handle<Value> function_name(const Arguments& args);
 * 里面就可以使用C++写各种底层操作了
 */
Handle<Value> sayHelloWorld(const Arguments& args){
    HandleScope scope;
    printf("Hello World!\n"); //打印一个“Hello World!”
    return scope.Close(Undefined()); //返回undefined
}

/**
 * 初始化函数，将需要导出的方法绑定到js对象上
 * 类似 export.XXX = function(){};
 */
void init(Handle<Object> target) {
    NODE_SET_METHOD(target, "say", sayHelloWorld);
}

NODE_MODULE(helloworld, init); //Node require的时候会执行的函数，整个模块的入口
```

有了C文件，怎么编译呢？`NodeJs`提供了`node-gyp`作为模块的编译工具，使用起来也非常简单，所需要的仅仅只有一个`Json`格式的`binding.gyp`文件**（里面的注释只是为了说明参数含义，但是会破坏`Json`结构，实际使用的时候需要去掉）**：
```
//binding.gyp
{
    "targets": [{
        "target_name": "helloworld", //模块名称
        "sources": [
            "helloworld.cpp"  //源代码列表
        ]
    }]
}
```

好了，我们所需要的就是这些了。接下来就是编译了：
```
node-gyp configure #生成Makefile等依赖文件
node-gyp build #编译模块
```

如果你够幸运的话，应该能在当前目录下的`build/Release/helloworld.node`找到生成的模块。
写个简单的脚本测试一下：
```
// test_helloworld.js
var helloworld = require("./build/Release/helloworld.node");
helloworld.say();
```

运行一下
```
node test_helloworld.js
```
如果没有错的话，应该能看到控制台输出`“Hello World!”`