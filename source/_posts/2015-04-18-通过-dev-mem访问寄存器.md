---
title: 通过/dev/mem访问寄存器
date: 2015-04-18 21:16:01
tags: 嵌入式
categories: Linux
---

上一篇文章[Linux下通过Python访问寄存器](http://192.168.1.7:2368/linuxxia-tong-guo-pythonfang-wen-ji-cun-qi/)，提到可以通过/dev/mem访问物理内存，实际上就是实现用户空间驱动的一种方法。

但是不是所有的系统都有Python环境，所以用C语言实现了一个版本，代码如下：

```
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>


#define WORDSIZE 4

/*
 * 字符串转数值
 */
static int mstrtol(char *nstr, unsigned int *val)
{
    char *endptr;

    /*
     * 将用户输入的16进制字符串转换成数值
     */
    *val = strtol(nstr, &endptr, 16);

    /*
     *  字符串中含有未能解析的值
     */
    if(strlen(nstr) != (endptr - nstr)) {
        printf("unknown value %s, is it a hex value?\n", nstr);
        return -1;
    }

    return 0;
}



/*
 * 打印寄存器的值
 * 参数:
 *      addr:   寄存器地址
 * 返回值：
 *      成功读出返回寄存器的值，否则返回0.
 */
unsigned int md(unsigned int addr)
{
    int fd;
    char *mem;
    unsigned int readword;
    unsigned int pagesize = getpagesize();
    unsigned int base_addr = addr & ~(pagesize - 1);
    unsigned int offset = addr - base_addr;

    fd = open("/dev/mem", O_RDWR | O_SYNC);

    if(fd == -1) {
        perror("open /dev/mem failed.");
        return 0;
    }

    mem = mmap(0, pagesize, PROT_READ | PROT_WRITE, MAP_SHARED, fd, base_addr);

    if(mem == MAP_FAILED) {
        perror("mmap /dev/mem failed.");
        return 0;
    }


    readword = *((unsigned int *)(mem + offset));

    munmap(mem, pagesize);

    close(fd);

    return readword;
}

/*
 * 设置寄存器的值
 * 参数:
 *      addr:   寄存器地址
 *      val:    要写入寄存器的值
 * 返回值：
 *      成功写入返回0，否则返回-1；
 */
unsigned int mw(unsigned int addr, unsigned int val)
{
    int fd;
    char *mem;
    unsigned int readword;
    unsigned int pagesize = getpagesize();
    unsigned int base_addr = addr & (pagesize - 1);
    unsigned int offset = addr - base_addr;

    fd = open("/dev/mem", O_RDWR | O_SYNC);

    if(fd == -1) {
        perror("open /dev/mem failed.");
        return -1;
    }

    mem = mmap(0, pagesize, PROT_READ | PROT_WRITE, MAP_SHARED, fd, base_addr);

    if(mem == MAP_FAILED) {
        perror("mmap /dev/mem failed.");
        return -1;
    }

    *((unsigned int *)(mem + offset)) = val;

    return 0;
}


void print_help()
{
  printf("usage:\nmdw -r addr\nmdw -w addr val\n");
}

int main(int argc, char **argv)
{
    unsigned int addr = 0;
  unsigned int val = 0;

  unsigned int rw = 0;

    if(argc < 3) {
    print_help();
    return -1;
  }

  if(strcmp(argv[1], "-r") != 0 && strcmp(argv[1], "-w") != 0 ) {
    print_help();
    return -1;
  } else if(strcmp(argv[1], "-r") == 0) {
    rw = 0;
  } else {
    rw = 1;
  }

  if(mstrtol(argv[2], &addr)) {
    return -1;
    }

  addr &= ~(0x03);

  if(rw == 0) {
    printf("0x%08X\n", md(addr));
  } else {
    if(mstrtol(argv[3], &val)) {
        return -1;
    }
    mw(addr, val);
  }

    return 0;
}
```