---
title: 使用Python访问寄存器
date: 2015-04-17 21:15:02
tags: Python
categories: Linux
---

/dev/mem是物理内存的全映像，可以用来访问物理内存，一般用法是open("/dev/mem",O_RDWR|O_SYNC)，然后mmap，接着就可以用mmap的地址来访问物理内存，这实际上就是实现用户空间驱动的一种方法。

python也提供了mmap方法，因此理论上也可以通过python访问arm的寄存器。由于python是一种解释型语言，编写的脚本很容易更改而不用重新编译，因此该方法在调试时非常有用。

脚本：
```
#!/usr/bin/python
# -*- coding: utf-8 -*-
'''
提供通过/dev/mem接口读写寄存器的方法
    md - memory display
    mw - memory write

用法：
    md addr
    mw addr value
'''

import os, mmap, struct
import sys, optparse

word_size = 4

def md(addr):
    '''
    mmap的内存按页对齐
    '''
    base_addr = addr & ~(mmap.PAGESIZE - 1)
    offset = addr - base_addr
    length = offset + word_size

    f = os.open("/dev/mem", os.O_RDWR | os.O_SYNC)
    mem = mmap.mmap(f, length, mmap.MAP_SHARED, 
            mmap.PROT_READ | mmap.PROT_WRITE,
            offset=base_addr)
    os.close(f)

    packed_reg = mem[offset:offset+word_size]

    mem.close()

    reg = struct.unpack("<I", packed_reg)[0]

    return reg

def mw(addr, val):
    '''
    mmap的内存按页对齐
    '''
    base_addr = addr & ~(mmap.PAGESIZE - 1)
    offset = addr - base_addr
    length = offset + word_size

    f = os.open("/dev/mem", os.O_RDWR | os.O_SYNC)
    mem = mmap.mmap(f, length, mmap.MAP_SHARED, 
            mmap.PROT_READ | mmap.PROT_WRITE,
            offset=base_addr)
    os.close(f)

    mem[offset:offset+word_size] = struct.pack("<I", val)

    mem.close()

    return 0


def main():
    parser = optparse.OptionParser()

    parser.add_option('-r', '--read', dest='read', metavar='ADDR',
            nargs=1, type=int, help='read a value')

    parser.add_option('-w', '--write', dest='write', metavar='ADDR VALUE',
            nargs=2, type=int, help='write a value')

    (options, args) = parser.parse_args()

    if options.write is not None and options.read is not None:
        parser.print_help()
        print '\nError: Both read and write are specified'
        return -1
    elif options.write is None and options.read is None:
        parser.print_help()
        print '\nError: Neither read or write are specified'
        return -1

    if options.read is not None:
        print '%08X: %08X' % (options.read, md(options.read))
    else:
        mw(options.write[0], options.write[1])
        print '%08X: %08X' % (options.write[0], md(options.write[0]))


if __name__ == '__main__':
    sys.exit(main())
```